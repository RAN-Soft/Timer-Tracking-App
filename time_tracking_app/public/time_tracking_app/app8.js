import{d as ve,r as d,g as P,a as E,b as W,c as fe,e as Z,o as ce,f as ge,h as me,s as ke,i as m,w as t,u as e,I as pe,j as a,k as ye,l as Se,m as i,n as _e,p as L,q as we,t as Ie,v as f,x as be,y as $,z as X,A as p,B as he,C as Pe,D as y,E as Ee,F as v,G as S,H as O,J as j,K as V,L as M,M as w,N as Le,O as I,P as Y,Q as N,R as Ce,S as Te,T as Ae,U as o,V as ee}from"./app.js";import{u as Ge,S as Be}from"./app10.js";const De={key:0},Oe={key:1},je={key:0},Ve={key:1},Me={key:0},Ne={key:1},ze={key:0},Ue=ve({__name:"TimePage",setup(He){const r=d(P()),s=d(E()),C=d(!1),T=d(navigator.onLine),z=d(W()),c=d(r.value[0]?.id??null),g=d(s.value[0]?.id??null),A=d(!1),_=d(!1),b=d(!1),k=d(null),G=d(!1),H=d(""),{userInitials:te,avatarColor:ne,loadUserInitials:ae,logout:le}=Ge(),ue=fe(()=>z.value.find(l=>!l.end)),x=d(Z());function h(){z.value=W(),x.value=Z()}function R(l){return new Date(l).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function B(l){return r.value.find(n=>n.id===l)}function oe(l){return s.value.find(n=>n.id===l)}function D(l){H.value=l,G.value=!0}async function ie(){await le()}function U(){if(!("geolocation"in navigator)){k.value="Diese App kann ohne GPS nicht verwendet werden. Bitte ein Gerät mit Standortfunktion verwenden.";return}b.value=!0,k.value=null,navigator.geolocation.getCurrentPosition(()=>{b.value=!1,k.value=null},l=>{b.value=!1,l.code===l.PERMISSION_DENIED?k.value="Bitte Standortzugriff erlauben. Ohne GPS-Freigabe kann die Zeiterfassung nicht verwendet werden.":k.value="Standort konnte nicht ermittelt werden. Bitte GPS aktivieren und erneut versuchen."},{enableHighAccuracy:!0,timeout:1e4})}function re(){U()}ce(async()=>{await ae();try{const l=await ge();if(l){const n=l.allow_geolocation_tracking===1||l.allow_geolocation_tracking===!0||l.allow_geolocation_tracking==="1";A.value=n,n&&U()}}catch(l){console.warn("HR Settings konnten nicht geladen werden",l)}await K(),h(),window.addEventListener("online",F),window.addEventListener("offline",J),window.addEventListener("tta-sync-updated",q)}),me(()=>{window.removeEventListener("online",F),window.removeEventListener("offline",J),window.removeEventListener("tta-sync-updated",q)});function F(){T.value=!0}function J(){T.value=!1}function q(){r.value=P(),s.value=E(),!c.value&&r.value.length>0&&(c.value=r.value[0].id),!g.value&&s.value.length>0&&(g.value=s.value[0].id),h()}async function K(){if(r.value=P(),s.value=E(),!(r.value.length>0&&s.value.length>0)){if(!navigator.onLine){console.warn("Keine Stammdaten & offline → kann nichts laden");return}try{C.value=!0,await ke(),r.value=P(),s.value=E(),r.value.length>0&&!c.value&&(c.value=r.value[0].id),s.value.length>0&&!g.value&&(g.value=s.value[0].id)}catch(l){console.error("ensureMasterDataLoaded error",l)}finally{C.value=!1}}}function Q(l){!c.value||!g.value||(Ae(c.value,g.value,l),h())}function se(){if(!(!c.value||!g.value))if(A.value){if(!("geolocation"in navigator)){D("Ohne GPS ist Stempeln nicht möglich.");return}_.value=!0,navigator.geolocation.getCurrentPosition(l=>{_.value=!1;const{latitude:n,longitude:u}=l.coords;Q({lat:n,lng:u})},l=>{_.value=!1,l.code===l.PERMISSION_DENIED?D("Bitte Standortzugriff erlauben. Ohne GPS ist Stempeln nicht möglich."):D("Standort konnte nicht ermittelt werden.")},{enableHighAccuracy:!0,timeout:1e4})}else Q()}async function de(){await Te(),await K(),h()}return(l,n)=>(o(),m(e(pe),null,{default:t(()=>[a(e(be),null,{default:t(()=>[a(e(ye),{color:"primary"},{default:t(()=>[a(e(Se),null,{default:t(()=>[...n[3]||(n[3]=[i("Time Tracking",-1)])]),_:1}),a(e(_e),{slot:"end"},{default:t(()=>[a(e(L),{id:"user-avatar-btn-time"},{default:t(()=>[a(e(we),{class:"avatar-bubble",style:Ie({background:e(ne)})},{default:t(()=>[i(f(e(te)),1)]),_:1},8,["style"])]),_:1})]),_:1})]),_:1})]),_:1}),a(e(Ee),{trigger:"user-avatar-btn-time","trigger-action":"click"},{default:t(()=>[a(e($),null,{default:t(()=>[a(e(X),null,{default:t(()=>[a(e(p),{button:"",onClick:ie},{default:t(()=>[a(e(he),{slot:"start",icon:e(Pe)},null,8,["icon"]),a(e(y),null,{default:t(()=>[...n[4]||(n[4]=[i("Abmelden",-1)])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(e($),{class:"ion-padding"},{default:t(()=>[k.value?(o(),v(I,{key:0},[a(e(O),null,{default:t(()=>[a(e(j),null,{default:t(()=>[a(e(V),null,{default:t(()=>[...n[5]||(n[5]=[i("GPS erforderlich",-1)])]),_:1})]),_:1}),a(e(M),null,{default:t(()=>[w("p",null,f(k.value),1),a(e(L),{expand:"block",class:"ion-margin-top",onClick:re},{default:t(()=>[...n[6]||(n[6]=[i(" Erneut versuchen ",-1)])]),_:1})]),_:1})]),_:1}),b.value?(o(),m(e(p),{key:0,lines:"none"},{default:t(()=>[a(e(y),null,{default:t(()=>[...n[7]||(n[7]=[i("Prüfe GPS…",-1)])]),_:1}),a(e(Le),{slot:"end"})]),_:1})):S("",!0)],64)):(o(),v(I,{key:1},[a(Be),a(e(L),{expand:"block",color:"medium",onClick:de},{default:t(()=>[...n[8]||(n[8]=[i(" Jetzt synchronisieren ",-1)])]),_:1}),a(e(O),null,{default:t(()=>[a(e(j),null,{default:t(()=>[a(e(V),null,{default:t(()=>[...n[9]||(n[9]=[i("Stempeln",-1)])]),_:1})]),_:1}),a(e(M),null,{default:t(()=>[r.value.length===0||s.value.length===0?(o(),m(e(p),{key:0},{default:t(()=>[a(e(y),{color:"medium"},{default:t(()=>[C.value?(o(),v("div",De," Lade Projekte und Aktivitäten… ")):(o(),v("div",Oe,[n[10]||(n[10]=i(" Es sind noch keine Projekte/Aktivitäten geladen. ",-1)),n[11]||(n[11]=w("br",null,null,-1)),T.value?(o(),v("span",Ve," Tippe auf „Jetzt synchronisieren“, um Stammdaten zu laden. ")):(o(),v("span",je," Bitte verbinde dich einmal mit dem Internet und tippe auf „Jetzt synchronisieren“, um Stammdaten zu laden. "))]))]),_:1})]),_:1})):S("",!0),r.value.length>0?(o(),m(e(p),{key:1},{default:t(()=>[a(e(y),null,{default:t(()=>[...n[12]||(n[12]=[i("Projekt",-1)])]),_:1}),a(e(Y),{modelValue:c.value,"onUpdate:modelValue":n[0]||(n[0]=u=>c.value=u)},{default:t(()=>[(o(!0),v(I,null,N(r.value,u=>(o(),m(e(ee),{key:u.id,value:u.id},{default:t(()=>[i(f(u.number?u.name+" ("+u.number+")":u.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})):S("",!0),s.value.length>0?(o(),m(e(p),{key:2},{default:t(()=>[a(e(y),null,{default:t(()=>[...n[13]||(n[13]=[i("Aktivität",-1)])]),_:1}),a(e(Y),{modelValue:g.value,"onUpdate:modelValue":n[1]||(n[1]=u=>g.value=u)},{default:t(()=>[(o(!0),v(I,null,N(s.value,u=>(o(),m(e(ee),{key:u.id,value:u.id},{default:t(()=>[i(f(u.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})):S("",!0),A.value?(o(),m(e(p),{key:3,lines:"none"},{default:t(()=>[a(e(y),{color:"medium"},{default:t(()=>[...n[14]||(n[14]=[i(" GPS ist für das Stempeln erforderlich (Geo-Tracking in HRMS aktiv). ",-1)])]),_:1})]),_:1})):S("",!0),a(e(L),{expand:"block",class:"ion-margin-top",disabled:!c.value||!g.value||_.value||r.value.length===0||s.value.length===0,onClick:se},{default:t(()=>[_.value?(o(),v("span",Me," Warte auf Standort… ")):(o(),v("span",Ne,f(ue.value?"Stopp":"Start"),1))]),_:1},8,["disabled"])]),_:1})]),_:1}),a(e(O),null,{default:t(()=>[a(e(j),null,{default:t(()=>[a(e(V),null,{default:t(()=>[...n[15]||(n[15]=[i("Heutige Einträge",-1)])]),_:1})]),_:1}),a(e(M),null,{default:t(()=>[a(e(X),null,{default:t(()=>[(o(!0),v(I,null,N(x.value,u=>(o(),m(e(p),{key:u.id},{default:t(()=>[a(e(y),null,{default:t(()=>[w("h2",null,[i(f(B(u.projectId)?.name)+" ",1),B(u.projectId)?.number?(o(),v("span",ze," ("+f(B(u.projectId)?.number)+") ",1)):S("",!0),i(" – "+f(oe(u.activityId)?.name),1)]),w("p",null,f(R(u.start))+" - "+f(u.end?R(u.end):"läuft…"),1),w("p",null,"Status: "+f(u.syncStatus),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1}),a(e(Ce),{"is-open":G.value,message:H.value,duration:2500,onDidDismiss:n[2]||(n[2]=u=>G.value=!1)},null,8,["is-open","message"])],64))]),_:1})]),_:1}))}});export{Ue as default};
