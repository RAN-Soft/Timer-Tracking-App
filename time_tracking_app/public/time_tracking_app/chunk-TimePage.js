import{d as he,r as s,g as O,a as D,b as ee,c as Ie,e as te,o as be,f as ne,h as Ee,i as Pe,s as Ce,j as k,w as t,u as e,I as Le,k as a,l as Te,m as Oe,n as i,p as De,q as A,t as Ae,v as Be,x as g,y as je,z as ae,A as le,B as _,C as Ge,D as Ne,E as S,F as Ve,G as v,H as E,J as x,K as z,L as M,M as H,N as P,O as xe,P as C,Q as oe,R as U,S as ze,T as Me,U as ue,V as ie,W as He,X as u,Y as re,_ as Ue}from"./app.js";import{u as Re,S as Fe}from"./chunk-userAvatar.js";const Je={key:0},Ke={key:1},We={key:0},qe={key:1},Qe={key:0},Xe={key:1},Ye={key:0},Ze=he({__name:"TimePage",setup($e){const L=s(null),d=s(O()),c=s(D()),B=s(!1),j=s(navigator.onLine),R=s(ee()),m=s(d.value[0]?.id??null),y=s(c.value[0]?.id??null),F=s(!1),h=s(!1),T=s(!1),w=s(null),G=s(!1),J=s(""),{userInitials:se,avatarColor:de,loadUserInitials:ce,logout:ve}=Re(),N=Ie(()=>R.value.find(o=>!o.end)),K=s(te());function I(){R.value=ee(),K.value=te()}function W(o){return new Date(o).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function V(o){return d.value.find(n=>n.id===o)}function fe(o){return c.value.find(n=>n.id===o)}function b(o){J.value=o,G.value=!0}async function ge(){await ve()}function q(){if(!("geolocation"in navigator)){w.value="Diese App kann ohne GPS nicht verwendet werden. Bitte ein Gerät mit Standortfunktion verwenden.";return}T.value=!0,w.value=null,navigator.geolocation.getCurrentPosition(()=>{T.value=!1,w.value=null},o=>{T.value=!1,o.code===o.PERMISSION_DENIED?w.value="Bitte Standortzugriff erlauben. Ohne GPS-Freigabe kann die Zeiterfassung nicht verwendet werden.":w.value="Standort konnte nicht ermittelt werden. Bitte GPS aktivieren und erneut versuchen."},{enableHighAccuracy:!0,timeout:1e4})}function me(){q()}be(async()=>{await ce();try{L.value=await ne()}catch(o){console.warn("Konnte Employee nicht laden",o)}try{const o=await Ee();if(o){const n=o.allow_geolocation_tracking===1||o.allow_geolocation_tracking===!0||o.allow_geolocation_tracking==="1";F.value=n,n&&q()}}catch(o){console.warn("HR Settings konnten nicht geladen werden",o)}await Z(),I(),window.addEventListener("online",Q),window.addEventListener("offline",X),window.addEventListener("tta-sync-updated",Y)}),Pe(()=>{window.removeEventListener("online",Q),window.removeEventListener("offline",X),window.removeEventListener("tta-sync-updated",Y)});function Q(){j.value=!0}function X(){j.value=!1}function Y(){d.value=O(),c.value=D(),!m.value&&d.value.length>0&&(m.value=d.value[0].id),!y.value&&c.value.length>0&&(y.value=c.value[0].id),I()}async function Z(){if(d.value=O(),c.value=D(),!(d.value.length>0&&c.value.length>0)){if(!navigator.onLine){console.warn("Keine Stammdaten & offline → kann nichts laden");return}try{B.value=!0,await Ce(),d.value=O(),c.value=D(),d.value.length>0&&!m.value&&(m.value=d.value[0].id),c.value.length>0&&!y.value&&(y.value=c.value[0].id)}catch(o){console.error("ensureMasterDataLoaded error",o)}finally{B.value=!1}}}async function ye(){if(!m.value||!y.value)return;const o=!N.value,n=new Date().toISOString(),l=async()=>(L.value||(L.value=await ne()),L.value),ke=async r=>{if(ue(m.value,y.value,r),I(),!!navigator.onLine)try{const f=await l();if(!f)return;const p={employee:f,time:n,log_type:"IN",latitude:r?.lat,longitude:r?.lng};await ie(p)}catch(f){console.error("Direkter Check-In fehlgeschlagen",f),b("Check-In gespeichert, aber konnte nicht direkt übertragen werden.")}},we=async r=>{const f=N.value;if(f&&(ue(m.value,y.value,r),I(),!!navigator.onLine))try{const p=await l();if(!p)return;const _e={employee:p,time:n,log_type:"OUT",latitude:r?.lat,longitude:r?.lng};await ie(_e);const Se={employee:p,project:f.projectId,activity_type:f.activityId,from_time:f.start,to_time:n,note:""};await He(Se)}catch(p){console.error("Direkter Check-Out/Timesheet fehlgeschlagen",p),b("Stopp gespeichert, aber konnte nicht direkt übertragen werden.")}},$=async r=>{o?await ke(r):await we(r)};if(F.value){if(!("geolocation"in navigator)){b("Ohne GPS ist Stempeln nicht möglich.");return}h.value=!0,navigator.geolocation.getCurrentPosition(async r=>{h.value=!1;const{latitude:f,longitude:p}=r.coords;await $({lat:f,lng:p})},r=>{h.value=!1,r.code===r.PERMISSION_DENIED?b("Bitte Standortzugriff erlauben. Ohne GPS ist Stempeln nicht möglich."):b("Standort konnte nicht ermittelt werden.")},{enableHighAccuracy:!0,timeout:1e4})}else await $()}async function pe(){await Me(),await Z(),I()}return(o,n)=>(u(),k(e(Le),null,{default:t(()=>[a(e(je),null,{default:t(()=>[a(e(Te),{color:"primary"},{default:t(()=>[a(e(Oe),null,{default:t(()=>[...n[3]||(n[3]=[i("Time Tracking",-1)])]),_:1}),a(e(De),{slot:"end"},{default:t(()=>[a(e(A),{id:"user-avatar-btn-time"},{default:t(()=>[a(e(Ae),{class:"avatar-bubble",style:Be({background:e(de)})},{default:t(()=>[i(g(e(se)),1)]),_:1},8,["style"])]),_:1})]),_:1})]),_:1})]),_:1}),a(e(Ve),{trigger:"user-avatar-btn-time","trigger-action":"click"},{default:t(()=>[a(e(ae),null,{default:t(()=>[a(e(le),null,{default:t(()=>[a(e(_),{button:"",onClick:ge},{default:t(()=>[a(e(Ge),{slot:"start",icon:e(Ne)},null,8,["icon"]),a(e(S),null,{default:t(()=>[...n[4]||(n[4]=[i("Abmelden",-1)])]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),a(e(ae),{class:"ion-padding"},{default:t(()=>[w.value?(u(),v(C,{key:0},[a(e(x),null,{default:t(()=>[a(e(z),null,{default:t(()=>[a(e(M),null,{default:t(()=>[...n[5]||(n[5]=[i("GPS erforderlich",-1)])]),_:1})]),_:1}),a(e(H),null,{default:t(()=>[P("p",null,g(w.value),1),a(e(A),{expand:"block",class:"ion-margin-top",onClick:me},{default:t(()=>[...n[6]||(n[6]=[i(" Erneut versuchen ",-1)])]),_:1})]),_:1})]),_:1}),T.value?(u(),k(e(_),{key:0,lines:"none"},{default:t(()=>[a(e(S),null,{default:t(()=>[...n[7]||(n[7]=[i("Prüfe GPS…",-1)])]),_:1}),a(e(xe),{slot:"end"})]),_:1})):E("",!0)],64)):(u(),v(C,{key:1},[a(Fe),a(e(A),{expand:"block",color:"medium",onClick:pe},{default:t(()=>[...n[8]||(n[8]=[i(" Jetzt synchronisieren ",-1)])]),_:1}),a(e(x),null,{default:t(()=>[a(e(z),null,{default:t(()=>[a(e(M),null,{default:t(()=>[...n[9]||(n[9]=[i("Stempeln",-1)])]),_:1})]),_:1}),a(e(H),null,{default:t(()=>[d.value.length===0||c.value.length===0?(u(),k(e(_),{key:0},{default:t(()=>[a(e(S),{color:"medium"},{default:t(()=>[B.value?(u(),v("div",Je," Lade Projekte und Aktivitäten… ")):(u(),v("div",Ke,[n[10]||(n[10]=i(" Es sind noch keine Projekte/Aktivitäten geladen. ",-1)),n[11]||(n[11]=P("br",null,null,-1)),j.value?(u(),v("span",qe," Tippe auf „Jetzt synchronisieren“, um Stammdaten zu laden. ")):(u(),v("span",We," Bitte verbinde dich einmal mit dem Internet und tippe auf „Jetzt synchronisieren“, um Stammdaten zu laden. "))]))]),_:1})]),_:1})):E("",!0),d.value.length>0?(u(),k(e(_),{key:1},{default:t(()=>[a(e(S),null,{default:t(()=>[...n[12]||(n[12]=[i("Projekt",-1)])]),_:1}),a(e(oe),{modelValue:m.value,"onUpdate:modelValue":n[0]||(n[0]=l=>m.value=l)},{default:t(()=>[(u(!0),v(C,null,U(d.value,l=>(u(),k(e(re),{key:l.id,value:l.id},{default:t(()=>[i(g(l.number?l.name+" ("+l.number+")":l.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})):E("",!0),c.value.length>0?(u(),k(e(_),{key:2},{default:t(()=>[a(e(S),null,{default:t(()=>[...n[13]||(n[13]=[i("Aktivität",-1)])]),_:1}),a(e(oe),{modelValue:y.value,"onUpdate:modelValue":n[1]||(n[1]=l=>y.value=l)},{default:t(()=>[(u(!0),v(C,null,U(c.value,l=>(u(),k(e(re),{key:l.id,value:l.id},{default:t(()=>[i(g(l.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})):E("",!0),a(e(A),{expand:"block",class:"ion-margin-top",disabled:!m.value||!y.value||h.value||d.value.length===0||c.value.length===0,onClick:ye},{default:t(()=>[h.value?(u(),v("span",Qe," Warte auf Standort… ")):(u(),v("span",Xe,g(N.value?"Stopp":"Start"),1))]),_:1},8,["disabled"])]),_:1})]),_:1}),a(e(x),null,{default:t(()=>[a(e(z),null,{default:t(()=>[a(e(M),null,{default:t(()=>[...n[14]||(n[14]=[i("Heutige Einträge",-1)])]),_:1})]),_:1}),a(e(H),null,{default:t(()=>[a(e(le),null,{default:t(()=>[(u(!0),v(C,null,U(K.value,l=>(u(),k(e(_),{key:l.id},{default:t(()=>[a(e(S),null,{default:t(()=>[P("h2",null,[i(g(V(l.projectId)?.name)+" ",1),V(l.projectId)?.number?(u(),v("span",Ye," ("+g(V(l.projectId)?.number)+") ",1)):E("",!0),i(" – "+g(fe(l.activityId)?.name),1)]),P("p",null,g(W(l.start))+" - "+g(l.end?W(l.end):"läuft…"),1),P("p",null,"Status: "+g(l.syncStatus),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1}),a(e(ze),{"is-open":G.value,message:J.value,duration:2500,onDidDismiss:n[2]||(n[2]=l=>G.value=!1)},null,8,["is-open","message"])],64))]),_:1})]),_:1}))}}),nt=Ue(Ze,[["__scopeId","data-v-edd1d3cc"]]);export{nt as default};
