import{d as oe,r as u,g as _,a as w,b as H,c as G,e as ie,o as ue,f as se,h as M,s as R,i as re,j as g,w as n,u as a,I as de,k as l,l as ce,m as me,n as s,p as fe,q as F,t as z,v as q,x as J,y as h,z as T,A as C,B as K,C as p,D as O,F as j,E as Q,G as r,H as ve,J as ye,K as ge,L as pe,M as W,N as $,O as ke,P as Se,Q as Ie,R as _e,S as i,T as X,U as L}from"./app.js";import{S as we}from"./chunk-SyncStatusBar.js";const he={key:0},Te={key:1},Ce={key:0},Ne=oe({__name:"TimePage",setup(Ee){const d=u(_()),c=u(w()),m=u(d.value[0]?.id??null),f=u(c.value[0]?.id??null),E=u(!1),k=u(!1),I=u(null),D=u(H()),V=u(G()),P=ie(()=>D.value.find(o=>!o.end)),b=u(!1),B=u("");function S(o){B.value=o,b.value=!0}function v(){D.value=H(),V.value=G()}function U(o){return new Date(o).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function N(o){return d.value.find(t=>t.id===o)}function Y(o){return c.value.find(t=>t.id===o)}async function x(){return I.value||(I.value=await M()),I.value}async function Z(o){const t=W(m.value,f.value,o);if(v(),!!navigator.onLine)try{const y={employee:await x(),time:t.start,log_type:"IN",latitude:t.latitudeIn,longitude:t.longitudeIn};await $(y),ke(t.id),v()}catch(e){console.error("Direct IN failed",e),S(e?.message||"Check-In konnte nicht übertragen werden.")}}async function ee(o){const t=P.value;if(!t)return;const e=W(m.value,f.value,o);if(v(),!!navigator.onLine)try{const y=await x(),ne={employee:y,time:e.end,log_type:"OUT",latitude:e.latitudeOut,longitude:e.longitudeOut};await $(ne),Se(e.id);const le={employee:y,project:t.projectId,activity_type:t.activityId,from_time:t.start,to_time:e.end,note:""};await Ie(le),_e(e.id),v()}catch(y){console.error("Direct OUT/TS failed",y),S(y?.message||"Check-Out/Timesheet konnte nicht übertragen werden.")}}async function te(){if(!m.value||!f.value)return;const o=!P.value,t=async e=>{o?await Z(e):await ee(e)};if(E.value){if(!("geolocation"in navigator)){S("Ohne GPS ist Stempeln nicht möglich.");return}k.value=!0,navigator.geolocation.getCurrentPosition(async e=>{k.value=!1,await t({lat:e.coords.latitude,lng:e.coords.longitude})},e=>{k.value=!1,e.code===e.PERMISSION_DENIED?S("Bitte Standortzugriff erlauben. Ohne GPS ist Stempeln nicht möglich."):S("Standort konnte nicht ermittelt werden.")},{enableHighAccuracy:!0,timeout:1e4})}else await t()}async function ae(){await pe(),await R(),d.value=_(),c.value=w(),v()}function A(){d.value=_(),c.value=w(),v()}return ue(async()=>{try{const o=await se();if(o){const t=o.allow_geolocation_tracking===1||o.allow_geolocation_tracking===!0||o.allow_geolocation_tracking==="1";E.value=t}}catch{}try{I.value=await M()}catch{}navigator.onLine&&(await R(),d.value=_(),c.value=w(),!m.value&&d.value.length&&(m.value=d.value[0].id),!f.value&&c.value.length&&(f.value=c.value[0].id)),v(),window.addEventListener("tta-sync-updated",A)}),re(()=>{window.removeEventListener("tta-sync-updated",A)}),(o,t)=>(i(),g(a(de),null,{default:n(()=>[l(a(fe),null,{default:n(()=>[l(a(ce),{color:"primary"},{default:n(()=>[l(a(me),null,{default:n(()=>[...t[3]||(t[3]=[s("Time Tracking",-1)])]),_:1})]),_:1})]),_:1}),l(a(ge),{class:"ion-padding"},{default:n(()=>[l(we),l(a(F),null,{default:n(()=>[l(a(z),null,{default:n(()=>[l(a(q),null,{default:n(()=>[...t[4]||(t[4]=[s("Stempeln",-1)])]),_:1})]),_:1}),l(a(J),null,{default:n(()=>[d.value.length>0?(i(),g(a(T),{key:0},{default:n(()=>[l(a(C),null,{default:n(()=>[...t[5]||(t[5]=[s("Projekt",-1)])]),_:1}),l(a(K),{modelValue:m.value,"onUpdate:modelValue":t[0]||(t[0]=e=>m.value=e)},{default:n(()=>[(i(!0),p(j,null,O(d.value,e=>(i(),g(a(X),{key:e.id,value:e.id},{default:n(()=>[s(r(e.number?e.name+" ("+e.number+")":e.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})):h("",!0),c.value.length>0?(i(),g(a(T),{key:1},{default:n(()=>[l(a(C),null,{default:n(()=>[...t[6]||(t[6]=[s("Aktivität",-1)])]),_:1}),l(a(K),{modelValue:f.value,"onUpdate:modelValue":t[1]||(t[1]=e=>f.value=e)},{default:n(()=>[(i(!0),p(j,null,O(c.value,e=>(i(),g(a(X),{key:e.id,value:e.id},{default:n(()=>[s(r(e.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})):h("",!0),E.value?(i(),g(a(T),{key:2,lines:"none"},{default:n(()=>[l(a(C),{color:"medium"},{default:n(()=>[...t[7]||(t[7]=[s(" GPS ist für das Stempeln erforderlich (Geo-Tracking in HRMS aktiv). ",-1)])]),_:1})]),_:1})):h("",!0),l(a(Q),{expand:"block",class:"ion-margin-top",disabled:!m.value||!f.value||k.value,onClick:te},{default:n(()=>[k.value?(i(),p("span",he,"Warte auf Standort…")):(i(),p("span",Te,r(P.value?"Stopp":"Start"),1))]),_:1},8,["disabled"]),l(a(Q),{expand:"block",color:"medium",class:"ion-margin-top",onClick:ae},{default:n(()=>[...t[8]||(t[8]=[s(" Jetzt synchronisieren ",-1)])]),_:1})]),_:1})]),_:1}),l(a(F),null,{default:n(()=>[l(a(z),null,{default:n(()=>[l(a(q),null,{default:n(()=>[...t[9]||(t[9]=[s("Heutige Einträge",-1)])]),_:1})]),_:1}),l(a(J),null,{default:n(()=>[l(a(ve),null,{default:n(()=>[(i(!0),p(j,null,O(V.value,e=>(i(),g(a(T),{key:e.id},{default:n(()=>[l(a(C),null,{default:n(()=>[L("h2",null,[s(r(N(e.projectId)?.name)+" ",1),N(e.projectId)?.number?(i(),p("span",Ce," ("+r(N(e.projectId)?.number)+") ",1)):h("",!0),s(" – "+r(Y(e.activityId)?.name),1)]),L("p",null,r(U(e.start))+" - "+r(e.end?U(e.end):"läuft…"),1),L("p",null," IN: "+r(e.checkinSynced?"✔":"✖")+" | OUT: "+r(e.checkoutSynced?"✔":"✖")+" | TS: "+r(e.timesheetSynced?"✔":"✖"),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1}),l(a(ye),{"is-open":b.value,message:B.value,duration:3e3,onDidDismiss:t[2]||(t[2]=e=>b.value=!1)},null,8,["is-open","message"])]),_:1})]),_:1}))}});export{Ne as default};
