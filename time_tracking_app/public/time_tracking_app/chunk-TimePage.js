import{r as c,g as j,a as N,b as R,c as G,d as ie,o as ue,f as se,e as F,s as q,h as re,i as de,j as z,k as J,m as ce,l as me,n as fe,p as ve,q as ye,t as w,w as n,u as e,I as ge,v as l,x as pe,y as ke,z as m,A as Se,B as K,C as Q,D as W,E as $,F as O,G as L,H as V,J as X,K as Y,L as T,M as B,N as U,O as Z,P as f,Q as Ie,R as we,S as _e,T as s,U as ee,V as x}from"./app.js";import{S as he}from"./chunk-SyncStatusBar.js";function Te(){const g=c(j()),r=c(N()),p=c(g.value[0]?.id??null),d=c(r.value[0]?.id??null),k=c(!1),_=c(!1),S=c(null),C=c(R()),E=c(G()),h=ie(()=>C.value.find(o=>!o.end)),b=c(!1),P=c("");function v(o){P.value=o,b.value=!0}function y(){C.value=R(),E.value=G()}function D(o){return new Date(o).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function A(o){return g.value.find(i=>i.id===o)}function H(o){return r.value.find(i=>i.id===o)}async function a(){return S.value||(S.value=await F()),S.value}async function t(o){const i=z(p.value,d.value,o);if(y(),!!navigator.onLine)try{const I={employee:await a(),time:i.start,log_type:"IN",latitude:i.latitudeIn,longitude:i.longitudeIn};await J(I),ce(i.id),y()}catch(u){console.error("Direct IN failed",u),v(u?.message||"Check-In konnte nicht übertragen werden.")}}async function te(o){const i=h.value;if(!i)return;const u=z(p.value,d.value,o);if(y(),!!navigator.onLine)try{const I=await a(),le={employee:I,time:u.end,log_type:"OUT",latitude:u.latitudeOut,longitude:u.longitudeOut};await J(le),me(u.id);const oe={employee:I,project:i.projectId,activity_type:i.activityId,from_time:i.start,to_time:u.end,note:""};await fe(oe),ve(u.id),y()}catch(I){console.error("Direct OUT/TS failed",I),v(I?.message||"Check-Out/Timesheet konnte nicht übertragen werden.")}}async function ne(){if(!p.value||!d.value)return;const o=!h.value,i=async u=>{o?await t(u):await te(u)};if(k.value){if(!("geolocation"in navigator)){v("Ohne GPS ist Stempeln nicht möglich.");return}_.value=!0,navigator.geolocation.getCurrentPosition(async u=>{_.value=!1,await i({lat:u.coords.latitude,lng:u.coords.longitude})},u=>{_.value=!1,u.code===u.PERMISSION_DENIED?v("Bitte Standortzugriff erlauben. Ohne GPS ist Stempeln nicht möglich."):v("Standort konnte nicht ermittelt werden.")},{enableHighAccuracy:!0,timeout:1e4})}else await i()}async function ae(){await de(),await q(),g.value=j(),r.value=N(),y()}function M(){g.value=j(),r.value=N(),y()}return ue(async()=>{try{const o=await se();if(o){const i=o.allow_geolocation_tracking===1||o.allow_geolocation_tracking===!0||o.allow_geolocation_tracking==="1";k.value=i}}catch{}try{S.value=await F()}catch{}navigator.onLine&&(await q(),g.value=j(),r.value=N(),!p.value&&g.value.length&&(p.value=g.value[0].id),!d.value&&r.value.length&&(d.value=r.value[0].id)),y(),window.addEventListener("tta-sync-updated",M)}),re(()=>{window.removeEventListener("tta-sync-updated",M)}),{projects:g,activities:r,selectedProject:p,selectedActivity:d,geoRequired:k,waitingForLocation:_,timeEntries:C,todaysEntries:E,activeEntry:h,toastOpen:b,toastMessage:P,showToast:v,refreshEntries:y,formatTime:D,entryProject:A,entryActivity:H,onPunchClick:ne,syncNow:ae}}const Ce={key:0},Pe={key:1},Ee={key:0},Ne=ye({__name:"TimePage",setup(g){const{projects:r,activities:p,selectedProject:d,selectedActivity:k,geoRequired:_,waitingForLocation:S,todaysEntries:C,activeEntry:E,toastOpen:h,toastMessage:b,formatTime:P,entryProject:v,entryActivity:y,onPunchClick:D,syncNow:A}=Te();return(H,a)=>(s(),w(e(ge),null,{default:n(()=>[l(e(Se),null,{default:n(()=>[l(e(pe),{color:"primary"},{default:n(()=>[l(e(ke),null,{default:n(()=>[...a[3]||(a[3]=[m("Time Tracking",-1)])]),_:1})]),_:1})]),_:1}),l(e(_e),{class:"ion-padding"},{default:n(()=>[l(he),l(e(K),null,{default:n(()=>[l(e(Q),null,{default:n(()=>[l(e(W),null,{default:n(()=>[...a[4]||(a[4]=[m("Stempeln",-1)])]),_:1})]),_:1}),l(e($),null,{default:n(()=>[e(r).length>0?(s(),w(e(L),{key:0},{default:n(()=>[l(e(V),null,{default:n(()=>[...a[5]||(a[5]=[m("Projekt",-1)])]),_:1}),l(e(X),{modelValue:e(d),"onUpdate:modelValue":a[0]||(a[0]=t=>Y(d)?d.value=t:null)},{default:n(()=>[(s(!0),T(U,null,B(e(r),t=>(s(),w(e(ee),{key:t.id,value:t.id},{default:n(()=>[m(f(t.number?t.name+" ("+t.number+")":t.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})):O("",!0),e(p).length>0?(s(),w(e(L),{key:1},{default:n(()=>[l(e(V),null,{default:n(()=>[...a[6]||(a[6]=[m("Aktivität",-1)])]),_:1}),l(e(X),{modelValue:e(k),"onUpdate:modelValue":a[1]||(a[1]=t=>Y(k)?k.value=t:null)},{default:n(()=>[(s(!0),T(U,null,B(e(p),t=>(s(),w(e(ee),{key:t.id,value:t.id},{default:n(()=>[m(f(t.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})):O("",!0),e(_)?(s(),w(e(L),{key:2,lines:"none"},{default:n(()=>[l(e(V),{color:"medium"},{default:n(()=>[...a[7]||(a[7]=[m(" GPS ist für das Stempeln erforderlich (Geo-Tracking in HRMS aktiv). ",-1)])]),_:1})]),_:1})):O("",!0),l(e(Z),{expand:"block",class:"ion-margin-top",disabled:!e(d)||!e(k)||e(S),onClick:e(D)},{default:n(()=>[e(S)?(s(),T("span",Ce,"Warte auf Standort…")):(s(),T("span",Pe,f(e(E)?"Stopp":"Start"),1))]),_:1},8,["disabled","onClick"]),l(e(Z),{expand:"block",color:"medium",class:"ion-margin-top",onClick:e(A)},{default:n(()=>[...a[8]||(a[8]=[m(" Jetzt synchronisieren ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1}),l(e(K),null,{default:n(()=>[l(e(Q),null,{default:n(()=>[l(e(W),null,{default:n(()=>[...a[9]||(a[9]=[m("Heutige Einträge",-1)])]),_:1})]),_:1}),l(e($),null,{default:n(()=>[l(e(Ie),null,{default:n(()=>[(s(!0),T(U,null,B(e(C),t=>(s(),w(e(L),{key:t.id},{default:n(()=>[l(e(V),null,{default:n(()=>[x("h2",null,[m(f(e(v)(t.projectId)?.name)+" ",1),e(v)(t.projectId)?.number?(s(),T("span",Ee," ("+f(e(v)(t.projectId)?.number)+") ",1)):O("",!0),m(" – "+f(e(y)(t.activityId)?.name),1)]),x("p",null,f(e(P)(t.start))+" - "+f(t.end?e(P)(t.end):"läuft…"),1),x("p",null," IN: "+f(t.checkinSynced?"✔":"✖")+" | OUT: "+f(t.checkoutSynced?"✔":"✖")+" | TS: "+f(t.timesheetSynced?"✔":"✖"),1)]),_:2},1024)]),_:2},1024))),128))]),_:1})]),_:1})]),_:1}),l(e(we),{"is-open":e(h),message:e(b),duration:3e3,onDidDismiss:a[2]||(a[2]=t=>h.value=!1)},null,8,["is-open","message"])]),_:1})]),_:1}))}});export{Ne as default};
